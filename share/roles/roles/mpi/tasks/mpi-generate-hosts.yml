---
- hosts: all
  tasks:
  - name: Get number of cpus of each host
    shell: "nproc --all"
    register: host_cpus

- hosts: coordinator
  gather_facts: yes
  vars:
    exec_dir: "{{ execution_dir | default(ansible_env.HOME) }}"
    fileName : "{{ file_name | default('hosts') }}"
    mpich_style_: "{{ mpich_style | default(False) }}"


  tasks:



#  - meta: end_play

  - name: Remove hosts file
    file:
      path: "{{ exec_dir }}/{{ fileName }}"
      state: absent


  - name: Create hosts file
    file:
      path: "{{ exec_dir }}/{{ fileName }}"
      state: touch


  - name: "Add Ansible inventory mappings to {{ exec_dir }}/hosts"
    blockinfile:
      marker: ""
      path: "{{ exec_dir }}/{{ fileName }}"
      block: |
        {% for host in groups['all'] %}
        {{ hostvars[host].ansible_host }}:{{ hostvars[host].host_cpus.stdout }}
        {% endfor %}
    when: mpich_style_|bool


  - name: "Add Ansible inventory mappings to {{ exec_dir }}/hosts"
    blockinfile:
      marker: ""
      path: "{{ exec_dir }}/{{ fileName }}"
      block: |
        {% for host in groups['all'] %}
        {{ hostvars[host].ansible_host }} slots={{ hostvars[host].host_cpus.stdout }}
        {% endfor %}
    when: not mpich_style_|bool